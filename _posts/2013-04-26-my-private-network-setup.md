---
layout: post
title: 我的个人网络搭建过程
---


###关于我的个人网络的说明
1.基于互联网，能够在任何有互联网的地方存取我的私人文档，访问我的私人服务。
2.安全可靠

###为了安全可靠，服务器端使用的是openvpn
网络对外只打开特定的端口，局域网内有一个路由器，路由器下面连接了一个NAS，上面运行着openvpn服务，所有客户端想连接到openvpn服务必须具有密钥。局域网内部使用的网络IP是10.0.0.0/24，其中路由器使用的IP是10.0.0.1，NAS使用的IP是10.0.0.5，路由器连接在电信的光猫上面，光猫拨号上网，内部IP是192.168.1.1，路由器的外部IP是192.168.1.100，光猫会将openvpn的1194端口转发到路由器上面，路由器会将1194端口转发到NAS上，提供openvpn的接入。

###如何让openvpn的用户链接到局域网内部
通过上面的设置，openvpn的用户可以访问NAS的资源，但是不能访问局域网内部的其他计算机。为了访问局域网内的其他计算机关键在于两点。
1.openvpn用户需要将目的IP地址为10.0.0.0/24的数据包转发到NAS，因此需要在openvpn服务器设置路由（push "route 10.8.0.0 255.255.255.0"）将10.8.0.0网段通过openvpn线路传输到NAS。该路由信息会自动设置到连接openvpn的客户端。
2.NAS需要将收到的数据包通过本地网络接口eth0转发出去。为此需要将NAS收到的目的IP地址为10.0.0.0/24的信息转发到NAS的网络接口eth0，通过iptables实现（/sbin/iptables -t nat -A POSTROUTING -d 10.0.0.0/24 -o eth0 -j MASQUERADE），这里就是将路由处理后的数据包，如果目的IP地址在10.0.0.0/24中，则转发到网络接口eth0,这样openvpn用户就可以访问局域网内部的机器了。

###如何让内网机器访问openvpn用户
上面设置完成以后，局域网中的用户是不能访问openvpn的用户的，局域网发送到10.8.0.0/24的数据包，路由器会直接转发到光猫，不会发送到NAS，因此无法访问openvpn用户。为了实现访问也需要两点。
1.将客户端发送到10.8.0.0/24的数据包转发到NAS，我是在路由器上面配置的静态转发表，如果你的路由器不支持也可以在本地操作。
2.在NAS上添加一条转发规则（/sbin/iptables -t nat -A POSTROUTING -d 10.8.0.0/24 -o tun0 -j MASQUERADE） 将目的IP地址10.8.0.0/24的数据包，通过openvpn网络接口tun0转发出去。

###通过上面的设置，局域网用户和openvpn用户可以相互访问，当然包含局域网用户之间以及openvpn用户之间。

注：openvpn用户指通过openvpn连接到NAS中openvpn服务的客户端。

附：网络结构图

![](/assets/pic/2013/my-private-network-daemon.jpg)